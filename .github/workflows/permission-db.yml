name: Copy sys_page + sys_page_permission to all targets (psql)

on:
  workflow_dispatch:
    inputs:
      source_db:
        description: "Kaynak database 'name' değeri (örn: surms-test)"
        required: true
        type: string

jobs:
  copy-two-tables:
    runs-on: ubuntu-latest

    steps:

      - name: Check PR Author
        run: |
          # İş akışını başlatan kullanıcı (manuel tetikleyici)
          TRIGGER_USER="${{ github.actor }}"
    
          # İzin verilen kullanıcılar listesi
          ALLOWED_USERS=("mysoly" "msklc" "bayyavuz")
    
          # Kullanıcının izin verilen listede olup olmadığını kontrol et
          IS_ALLOWED=false
    
          for USER in "${ALLOWED_USERS[@]}"; do
            if [ "$USER" == "$TRIGGER_USER" ]; then
              IS_ALLOWED=true
              break
            fi
          done
    
          if [ "$IS_ALLOWED" = false ]; then
            echo "::error::Bu iş akışı '$TRIGGER_USER' tarafından başlatıldı. Sadece ${ALLOWED_USERS[*]} yetkilidir. İşlem İptal Ediliyor."
            exit 1
          fi
    
          echo "Başlatan Kullanıcı: '$TRIGGER_USER'. İşleme devam ediliyor."
        
      - name: Install psql and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq

      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard resolvconf

      - name: Write WireGuard config
        run: |
          echo "${{ secrets.WG0_CONF }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo chmod 600 /etc/wireguard/wg0.conf

      - name: Bring up WireGuard
        run: |
          sudo wg-quick up wg0
          sudo wg show

      - name: Check outbound IP (should be VPN IP)
        run: |
          curl -s https://ifconfig.me

      - name: Copy tables
        env:
          DATABASES_JSON: ${{ secrets.DATABASES_JSON }}
          SOURCE_DB_NAME: ${{ github.event.inputs.source_db }}

          SYS_PAGE_TABLE: "public.sys_page"
          SYS_PAGE_PERM_TABLE: "public.sys_page_permission"
        run: |
          set -euo pipefail
          echo "$DATABASES_JSON" > dbs.json

          # Kaynak DB'yi bul
          SOURCE_JSON=$(jq -c --arg name "$SOURCE_DB_NAME" '.[] | select(.name == $name)' dbs.json)
          if [ -z "$SOURCE_JSON" ]; then
            echo "ERROR: Source DB with name '$SOURCE_DB_NAME' not found in DATABASES_JSON"
            exit 1
          fi

          SRC_HOST=$(echo "$SOURCE_JSON" | jq -r '.host')
          SRC_PORT=$(echo "$SOURCE_JSON" | jq -r '.port // 5432')
          SRC_USER=$(echo "$SOURCE_JSON" | jq -r '.user')
          SRC_PASS=$(echo "$SOURCE_JSON" | jq -r '.password')
          SRC_DB=$(echo "$SOURCE_JSON" | jq -r '.dbname')

          echo "Source DB: $SOURCE_DB_NAME ($SRC_HOST/$SRC_DB)"
          export PGPASSWORD="$SRC_PASS"

          echo "Exporting from source..."
          psql "host=$SRC_HOST port=$SRC_PORT user=$SRC_USER dbname=$SRC_DB sslmode=require" -v ON_ERROR_STOP=1 \
            -c "\copy $SYS_PAGE_TABLE TO 'sys_page.csv' CSV"
          psql "host=$SRC_HOST port=$SRC_PORT user=$SRC_USER dbname=$SRC_DB sslmode=require" -v ON_ERROR_STOP=1 \
            -c "\copy $SYS_PAGE_PERM_TABLE TO 'sys_page_permission.csv' CSV"

          echo "Export done."

          # Target DB'ler
          jq -c --arg name "$SOURCE_DB_NAME" '.[] | select(.name != $name)' dbs.json | while read -r TGT_JSON; do
            TGT_NAME=$(echo "$TGT_JSON" | jq -r '.name')
            TGT_HOST=$(echo "$TGT_JSON" | jq -r '.host')
            TGT_PORT=$(echo "$TGT_JSON" | jq -r '.port // 5432')
            TGT_USER=$(echo "$TGT_JSON" | jq -r '.user')
            TGT_PASS=$(echo "$TGT_JSON" | jq -r '.password')
            TGT_DB=$(echo "$TGT_JSON" | jq -r '.dbname')

            echo
            echo "==== Copying to target: $TGT_NAME ($TGT_HOST/$TGT_DB) ===="
            export PGPASSWORD="$TGT_PASS"

            # ✅ Kritik: FK nedeniyle ikisini aynı statement içinde truncate ediyoruz
            echo "Running TRUNCATE: TRUNCATE TABLE $SYS_PAGE_PERM_TABLE, $SYS_PAGE_TABLE;"
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" -v ON_ERROR_STOP=1 \
              -c "TRUNCATE TABLE $SYS_PAGE_PERM_TABLE, $SYS_PAGE_TABLE;"

            # ✅ Import sırası: önce parent, sonra child
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" -v ON_ERROR_STOP=1 \
              -c "\copy $SYS_PAGE_TABLE FROM 'sys_page.csv' CSV"
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" -v ON_ERROR_STOP=1 \
              -c "\copy $SYS_PAGE_PERM_TABLE FROM 'sys_page_permission.csv' CSV"

            echo "Done for $TGT_NAME"
          done

          echo
          echo "All targets updated successfully."


