name: Copy sys_page and sys_page_permission to all targets

on:
  workflow_dispatch:
    inputs:
      source_db:
        description: "Kaynak database 'name' değeri"
        required: true
        type: string

jobs:
  copy-two-tables:
    runs-on: ubuntu-latest
    steps:
      - name: Install psql and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq

      - name: Copy tables
        env:
          DATABASES_JSON: ${{ secrets.DATABASES_JSON }}
          SOURCE_DB_NAME: ${{ github.event.inputs.source_db }}

          # === Burayı sabitliyoruz ===
          SYS_PAGE_TABLE: "public.sys_page"
          SYS_PAGE_PERM_TABLE: "public.sys_page_permission"
        run: |
          set -euo pipefail
          echo "$DATABASES_JSON" > dbs.json

          SOURCE_JSON=$(jq -c --arg name "$SOURCE_DB_NAME" '.[] | select(.name == $name)' dbs.json)
          if [ -z "$SOURCE_JSON" ]; then
            echo "ERROR: Source DB with name '$SOURCE_DB_NAME' not found in DATABASES_JSON"
            exit 1
          fi

          SRC_HOST=$(echo "$SOURCE_JSON" | jq -r '.host')
          SRC_PORT=$(echo "$SOURCE_JSON" | jq -r '.port // 5432')
          SRC_USER=$(echo "$SOURCE_JSON" | jq -r '.user')
          SRC_PASS=$(echo "$SOURCE_JSON" | jq -r '.password')
          SRC_DB=$(echo "$SOURCE_JSON" | jq -r '.dbname')

          echo "Source DB: $SOURCE_DB_NAME ($SRC_HOST/$SRC_DB)"
          export PGPASSWORD="$SRC_PASS"

          # 1) Kaynaktan iki tabloyu export et
          psql "host=$SRC_HOST port=$SRC_PORT user=$SRC_USER dbname=$SRC_DB sslmode=require" \
            -v ON_ERROR_STOP=1 \
            -c "\copy $SYS_PAGE_TABLE TO 'sys_page.csv' CSV"

          psql "host=$SRC_HOST port=$SRC_PORT user=$SRC_USER dbname=$SRC_DB sslmode=require" \
            -v ON_ERROR_STOP=1 \
            -c "\copy $SYS_PAGE_PERM_TABLE TO 'sys_page_permission.csv' CSV"

          echo "Export complete: sys_page.csv + sys_page_permission.csv"

          # 2) Target DB'lere uygula
          jq -c --arg name "$SOURCE_DB_NAME" '.[] | select(.name != $name)' dbs.json | while read -r TGT_JSON; do
            TGT_NAME=$(echo "$TGT_JSON" | jq -r '.name')
            TGT_HOST=$(echo "$TGT_JSON" | jq -r '.host')
            TGT_PORT=$(echo "$TGT_JSON" | jq -r '.port // 5432')
            TGT_USER=$(echo "$TGT_JSON" | jq -r '.user')
            TGT_PASS=$(echo "$TGT_JSON" | jq -r '.password')
            TGT_DB=$(echo "$TGT_JSON" | jq -r '.dbname')

            echo
            echo "==== Copying to target: $TGT_NAME ($TGT_HOST/$TGT_DB) ===="
            export PGPASSWORD="$TGT_PASS"

            # 2.1) Önce CHILD tabloyu temizle, sonra PARENT
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" \
              -v ON_ERROR_STOP=1 \
              -c "TRUNCATE TABLE $SYS_PAGE_TABLE;"
              
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" \
              -v ON_ERROR_STOP=1 \
              -c "TRUNCATE TABLE $SYS_PAGE_PERM_TABLE;"

            # 2.2) Import sırası: önce PARENT, sonra CHILD
            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" \
              -v ON_ERROR_STOP=1 \
              -c "\copy $SYS_PAGE_TABLE FROM 'sys_page.csv' CSV"

            psql "host=$TGT_HOST port=$TGT_PORT user=$TGT_USER dbname=$TGT_DB sslmode=require" \
              -v ON_ERROR_STOP=1 \
              -c "\copy $SYS_PAGE_PERM_TABLE FROM 'sys_page_permission.csv' CSV"

            echo "Done for $TGT_NAME"
          done

          echo
          echo "All targets updated successfully."

